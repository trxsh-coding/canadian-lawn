stages:
  - install
  - build
  - deploy

# Установка зависимостей (в начале!)
install:
  stage: install
  tags: [deploy]
  script:
    - corepack enable
    - yarn set version 4.9.2
    - yarn install --frozen-lockfile
  cache:
    key: "${CI_COMMIT_REF_SLUG}-yarn"
    paths:
      - .yarn/cache

# Сборка Web
build_web:
  stage: build
  tags: [deploy]
  needs: [install]
  script:
    - echo "$ENV_WEB" > apps/web/.env
    - yarn workspaces focus @canadian-lawn/ui-kit
    - yarn workspaces focus @canadian-lawn/api
    - yarn workspaces focus @canadian-lawn/web
    - yarn build:ui
    - yarn build:api
    - yarn build:web
  rules:
    - changes:
        - "apps/web/**/*"
        - "packages/ui-kit/**/*"
        - "packages/api/**/*"

# Сборка Backend + UI Kit
build_backend:
  stage: build
  tags: [deploy]
  needs: [install]
  script:
    - echo "$STRAPI_ENV_FILE" > apps/backend/.env

  rules:
    - changes:
        - "apps/backend/**/*"

# Деплой
deploy:
  stage: deploy
  tags: [deploy]
  needs:
    - build_web
    - build_backend
  script:
    - echo "$SUDO_PASSWORD" | sudo -S pm2 delete canadian-web || true
    - echo "$SUDO_PASSWORD" | sudo -S pm2 delete canadian-api || true
    - echo "$SUDO_PASSWORD" | sudo -S pm2 start ecosystem.config.cjs
    - echo "✅ Next.js успешно запущен, логи PM2:"
    - echo "$SUDO_PASSWORD" | sudo -S pm2 logs canadian-frontend --lines 20
