default:
  before_script:
    - if [ "$CI_COMMIT_REF_NAME" != "main" ]; then
      echo "▶️ Удаляю папку $DEST_DIR для ветки $CI_COMMIT_REF_NAME...";
      sudo rm -rf $DEST_DIR || true;
      else
      echo "❗️ Это ветка main, не трогаем $DEST_DIR.";
      fi
    - sudo mkdir -p $DEST_DIR
    - sudo chown $USER:$USER $DEST_DIR
    - mkdir -p $DEST_DIR/logs
stages:
  - db_up
  - build_and_deploy_web
  - build_and_deploy_backend

variables:
  DEST_DIR: "/var/www/canadian-lawn"

# ==========================
# ⚡️ POSTGRES (docker compose up)
# ==========================
db_up:
  stage: db_up
  tags:
    - deploy
  script:
    - if docker ps --filter "label=com.docker.compose.service=postgres" --format '{{.Names}}' | grep -q .; then
      echo "Postgres already running.";
      else
      echo "Starting Postgres...";
      docker compose up -d postgres;
      fi
  when: on_success

# ==========================
# ⚡️ WEB
# ==========================
build_and_deploy_web:
  stage: build_and_deploy_web
  tags:
    - deploy
  rules:
    - changes:
        - "apps/web/**/*"
        - "packages/ui-kit/**/*"
        - "packages/api/**/*"
        - "gitlab-ci.yml"
  script:
    - rsync -a . $DEST_DIR/
    - cd $DEST_DIR
    - corepack enable
    - yarn set version 4.9.2
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web
    - yarn install --no-immutable
    - yarn build:ui
    - yarn build:api
    - yarn build:web
    - echo "$ENV_WEB" > $DEST_DIR/apps/web/.env
    - pm2 delete canadian-web || true
    - pm2 start $DEST_DIR/ecosystem.frontend.config.cjs
    - pm2 save

# ==========================
# ⚡️ BACKEND
# ==========================
build_and_deploy_backend:
  stage: build_and_deploy_backend
  tags:
    - deploy
  needs:
    - job: db_up
      optional: true
  rules:
    - changes:
        - "apps/backend/**/*"
        - "gitlab-ci.yml"
  script:
    - rsync -a . $DEST_DIR/
    - cd $DEST_DIR
    - corepack enable
    - yarn set version 4.9.2
    - yarn workspaces focus @canadian-lawn/backend
    - yarn install --no-immutable
    - yarn build:backend
    - echo "$STRAPI_ENV_FILE" > $DEST_DIR/apps/backend/.env
    - yarn workspaces focus @canadian-lawn/backend --production
    - pm2 delete canadian-api || true
    - pm2 start $DEST_DIR/ecosystem.backend.config.cjs
    - pm2 save
