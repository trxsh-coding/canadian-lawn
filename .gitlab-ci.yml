stages:
  - verify
  - install
  - build
  - deploy

default:
  image: node:20
  before_script:
    - apt update && apt install -y openssh-client rsync
    - mkdir -p ~/.ssh
    - eval "$(ssh-agent -s)"          # â† ðŸ”‘ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ssh-agent
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - chmod 700 ~/.ssh
    - ssh-keyscan -H 158.160.181.102 >> ~/.ssh/known_hosts
    - corepack enable
    - yarn install --immutable


verify:
  stage: verify
  script:
    - yarn format:check
    - yarn lint
    - yarn build:all

install-deps:
  stage: install
  script:
    - echo "Already installed in before_script"

build-web:
  stage: build
  script:
    - yarn workspace @canadian-lawn/web build
  artifacts:
    paths:
      - apps/web/.next
      - apps/web/public
      - apps/web/package.json
    expire_in: 1h
  only:
    - stage

deploy-stage:
  stage: deploy
  script:
    - rsync -az --delete apps/web/.next/ orest@158.160.181.102:/var/www/canadian-lawn/web/.next/
    - rsync -az --delete apps/web/public/ orest@158.160.181.102:/var/www/canadian-lawn/web/public/
    - rsync -az apps/web/package.json orest@158.160.181.102:/var/www/canadian-lawn/web/
    - ssh orest@158.160.181.102 '
      cd /var/www/canadian-lawn/web &&
      yarn install --production &&
      pm2 restart canadian-web || pm2 start "yarn start" --name canadian-web
      '
  only:
    - stage
