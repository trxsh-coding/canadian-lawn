build_web:
  stage: build
  image: node:22

  cache:
    key: yarn-cache
    paths:
      - .yarn/cache
      - .yarn/install-state.gz
      - .yarn/build-state.yml
      - node_modules/

  before_script:
    - apt update && apt install -y openssh-client rsync
    - mkdir -p ~/.ssh
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - chmod 700 ~/.ssh
    - ssh-keyscan -H 158.160.181.102 >> ~/.ssh/known_hosts
    - corepack enable
    - yarn set version 4.9.2
    - yarn install --no-immutable
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web

  script:
    - echo "ğŸ”¨ Build UI Kit"
    - yarn build:ui || (echo "âŒ UI Kit build failed" && exit 1)
    - test -d packages/ui-kit/dist || (echo "âŒ dist/ui-kit Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½" && exit 1)

    - echo "ğŸ”¨ Build API"
    - yarn build:api || (echo "âŒ API build failed" && exit 1)
    - test -d packages/api/dist || (echo "âŒ dist/api Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½" && exit 1)

    - echo "ğŸ”¨ Build Web"
    - yarn build:web || (echo "âŒ Web build failed" && exit 1)
    - test -d apps/web/.next || (echo "âŒ .next Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½" && exit 1)

    - echo "ğŸš€ Deploy to server"
    - rsync -az --delete apps/web/.next/ orest@158.160.181.102:/var/www/canadian-lawn/web/.next/
    - rsync -az --delete apps/web/public/ orest@158.160.181.102:/var/www/canadian-lawn/web/public/
    - rsync -az apps/web/package.json orest@158.160.181.102:/var/www/canadian-lawn/web/
    - ssh orest@158.160.181.102 '
      cd /var/www/canadian-lawn/web &&
      yarn install --production &&
      pm2 restart canadian-web || pm2 start "yarn start" --name canadian-web
      '
    - echo "âœ… Deploy complete"

  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

  artifacts:
    when: always
    expire_in: 1h
    paths:
      - packages/ui-kit/dist
      - packages/api/dist
      - apps/web/.next
      - apps/web/public
      - apps/web/package.json
