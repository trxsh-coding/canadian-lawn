# Конфигурация GitLab CI/CD для проекта Canadian Lawn
# Определяет этапы подготовки, сборки, развертывания и управления базой данных

# Глобальные переменные
variables:
  BACKEND_DEST_DIR: "/var/www/canadian-lawn-backend"
  BACKEND_WORKING_DIR: "/var/www/canadian-lawn-backend"
  FRONTEND_DEST_DIR: "/var/www/canadian-lawn-frontend"
  FRONTEND_WORKING_DIR: "apps/web"
  YARN_CACHE_FOLDER: ".yarn/cache"
  POSTGRES_SERVICE: "postgres"

# Глобальные настройки, выполняемые перед каждым заданием
default:
  cache:
    paths:
      - $YARN_CACHE_FOLDER
    key: "${CI_COMMIT_REF_SLUG}-yarn"

# Определение этапов выполнения
stages:
  - setup
  - build-backend
  - deploy-backend
  - build-frontend
  - deploy-frontend

# Задание: Подготовка окружения (выполняется один раз)
setup:
  stage: setup
  tags:
    - deploy
  script:
    # Создание директории и установка прав
    # Копирование файлов
    - echo "⚙️ Настраиваю Yarn..."
    - corepack enable
    - yarn set version 4.9.2
    - yarn install --no-immutable

  when: always
  timeout: 5m

# Задание: Сборка и развертывание веб-приложения
build-frontend:
  stage: build-frontend
  tags:
    - deploy
  needs:
    - job: setup
  rules:
    # Выполняется при изменениях в указанных директориях или конфиге
    - changes:
        - "apps/web/**/*"
        - "packages/ui-kit/**/*"
        - "packages/api/**/*"
        - ".gitlab-ci.yml"
      when: always
  script:
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web  --production
    - echo "⚙️ Сохраняю .env для фронта..."
    - echo "$ENV_WEB" > "apps/web/.env"
    - echo "$ENV_WEB" > "packages/api/.env"
    - yarn build:all
  timeout: 15m

deploy-frontend:
  stage: deploy-frontend
  tags:
    - deploy
  needs:
    - job: build-frontend
      optional: true
  rules:
    # Выполняется при изменениях в бэкенде или конфиге
    - changes:
        - "apps/web/**/*"
        - ".gitlab-ci.yml"
      when: always
  script:
    - echo "Копируем файлики"
    - cd apps/web
    - rsync -a --include=".next/standalone/**" . "$FRONTEND_DEST_DIR"
    - rsync -a --include=".next/static" . "$FRONTEND_DEST_DIR/$FRONTEND_WORKING_DIR"
    - rsync -a --include="public" . "$FRONTEND_DEST_DIR/$FRONTEND_WORKING_DIR"
    - echo "Стартуем сервер"
    - cd $FRONTEND_WORKING_DIR
    - pm2 delete canadian-web || true
    - pm2 start server.js --name canadian-web
    - pm2 logs canadian-web --lines 20