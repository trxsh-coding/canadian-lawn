# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è GitLab CI/CD –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ Canadian Lawn
# –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–∞–ø—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, —Å–±–æ—Ä–∫–∏, —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
variables:
  DEST_DIR: "/var/www/canadian-lawn"
  YARN_CACHE_FOLDER: ".yarn/cache"
  POSTGRES_SERVICE: "postgres"

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–µ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–¥–∞–Ω–∏–µ–º
default:
  before_script:
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ pm2 –¥–ª—è –≤–µ—Ç–æ–∫, –∫—Ä–æ–º–µ main
    - |
      if [ "$CI_COMMIT_REF_NAME" != "main" ]; then
        echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∏ —É–¥–∞–ª—è—é –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã pm2 –¥–ª—è –≤–µ—Ç–∫–∏ $CI_COMMIT_REF_NAME..."
        echo "$SUDO_PASSWORD" | sudo -S pm2 stop all || true
        echo "$SUDO_PASSWORD" | sudo -S pm2 delete all || true
      else
        echo "‚ùóÔ∏è –í–µ—Ç–∫–∞ main, –ø—Ä–æ—Ü–µ—Å—Å—ã pm2 –Ω–µ —Ç—Ä–æ–≥–∞—é—Ç—Å—è."
      fi
  cache:
    paths:
      - $YARN_CACHE_FOLDER
    key: "${CI_COMMIT_REF_SLUG}-yarn"

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
stages:
  - setup
  - db_up
  - build_and_deploy_web
  - build_and_deploy_backend

# –ó–∞–¥–∞–Ω–∏–µ: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
setup:
  stage: setup
  tags:
    - deploy
  script:
    # –£–¥–∞–ª–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –≤–µ—Ç–æ–∫, –∫—Ä–æ–º–µ main
    - |
      if [ "$CI_COMMIT_REF_NAME" != "main" ]; then
        echo "‚ñ∂Ô∏è –£–¥–∞–ª—è—é –ø–∞–ø–∫—É $DEST_DIR –¥–ª—è –≤–µ—Ç–∫–∏ $CI_COMMIT_REF_NAME..."
        [ -d "$DEST_DIR" ] && echo "$SUDO_PASSWORD" | sudo -S rm -rf "$DEST_DIR" || echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $DEST_DIR –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ —É–¥–∞–ª–µ–Ω–∞."
      else
        echo "‚ùóÔ∏è –í–µ—Ç–∫–∞ main, –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $DEST_DIR –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è."
      fi
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤
    - echo "$SUDO_PASSWORD" | sudo -S mkdir -p "$DEST_DIR/logs"
    - echo "$SUDO_PASSWORD" | sudo -S chown -R $USER:$USER "$DEST_DIR"
    # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    - echo "üìÇ –ö–æ–ø–∏—Ä—É—é —Ñ–∞–π–ª—ã –≤ $DEST_DIR..."
    - rsync -a --exclude=".git" . "$DEST_DIR/"
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Yarn
    - cd "$DEST_DIR"
    - echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é Yarn..."
    - corepack enable
    - yarn set version 4.9.2
  when: always
  timeout: 5m

# –ó–∞–¥–∞–Ω–∏–µ: –ó–∞–ø—É—Å–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
db_up:
  stage: db_up
  tags:
    - deploy
  needs:
    - job: setup
  script:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL
    - cd "$DEST_DIR"
    - |
      if docker ps --filter "label=com.docker.compose.service=$POSTGRES_SERVICE" --format '{{.Names}}' | grep -q .; then
        echo "‚úÖ PostgreSQL —É–∂–µ –∑–∞–ø—É—â–µ–Ω."
      else
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é PostgreSQL..."
        echo "$SUDO_PASSWORD" | sudo -S docker-compose up -d $POSTGRES_SERVICE
      fi
  when: on_success
  timeout: 5m

# –ó–∞–¥–∞–Ω–∏–µ: –°–±–æ—Ä–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
build_and_deploy_web:
  stage: build_and_deploy_web
  tags:
    - deploy
  needs:
    - job: setup
  rules:
    # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥–µ
    - changes:
        - "apps/web/**/*"
        - "packages/ui-kit/**/*"
        - "packages/api/**/*"
        - ".gitlab-ci.yml"
      when: always
  script:
    - cd "$DEST_DIR"
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web
    - yarn install --no-immutable
    # –°–±–æ—Ä–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    - echo "üî® –°–±–æ—Ä–∫–∞ UI Kit..."
    - yarn build:ui
    - echo "üî® –°–±–æ—Ä–∫–∞ API..."
    - yarn build:api
    - echo "üî® –°–±–æ—Ä–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    - yarn build:web
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏
    - |
      if [ ! -d "apps/web/.next" ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
        exit 1
      fi
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    - echo "‚öôÔ∏è –°–æ–∑–¥–∞—é .env —Ñ–∞–π–ª –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    - echo "$ENV_WEB" > apps/web/.env
    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
    - echo "üöÄ –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
    - echo "$SUDO_PASSWORD" | sudo -S pm2 delete canadian-web || true
    - echo "$SUDO_PASSWORD" | sudo -S pm2 start ecosystem.frontend.config.cjs
    - echo "$SUDO_PASSWORD" | sudo -S pm2 save
  timeout: 15m

# –ó–∞–¥–∞–Ω–∏–µ: –°–±–æ—Ä–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞
build_and_deploy_backend:
  stage: build_and_deploy_backend
  tags:
    - deploy
  needs:
    - job: setup
    - job: db_up
      optional: true
  rules:
    # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –±—ç–∫–µ–Ω–¥–µ –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥–µ
    - changes:
        - "apps/backend/**/*"
        - ".gitlab-ci.yml"
      when: always
  script:
    - cd "$DEST_DIR"
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –±—ç–∫–µ–Ω–¥–∞..."
    - yarn workspaces focus @canadian-lawn/backend
    - yarn install --no-immutable
    # –°–±–æ—Ä–∫–∞ –±—ç–∫–µ–Ω–¥–∞
    - echo "üî® –°–±–æ—Ä–∫–∞ –±—ç–∫–µ–Ω–¥–∞..."
    - yarn build:backend
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏
    - |
      if [ ! -d "apps/backend/dist" ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è dist –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
        exit 1
      fi
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    - echo "‚öôÔ∏è –ö–æ–ø–∏—Ä—É—é .env —Ñ–∞–π–ª –¥–ª—è –±—ç–∫–µ–Ω–¥–∞..."
    - |
      if [ -f ".env" ]; then
        echo "$SUDO_PASSWORD" | sudo -S echo "$STRAPI_ENV_FILE" > apps/backend/.env
      else
        echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è!"
        exit 1
      fi
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
    - echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞..."
    - yarn workspaces focus @canadian-lawn/backend --production
    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
    - echo "üöÄ –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é –±—ç–∫–µ–Ω–¥..."
    - echo "$SUDO_PASSWORD" | sudo -S pm2 delete canadian-api || true
    - echo "$SUDO_PASSWORD" | sudo -S pm2 start ecosystem.backend.config.cjs
    - echo "$SUDO_PASSWORD" | sudo -S pm2 save
  timeout: 15m