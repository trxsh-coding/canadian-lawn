stages:
  - install
  - build
  - deploy

default:
  image: node:22.16
  before_script:
    - corepack enable
    - corepack prepare yarn@4.0.1 --activate
    - yarn --version
    - apt update && apt install -y openssh-client rsync
    - mkdir -p ~/.ssh
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - chmod 700 ~/.ssh
    - ssh-keyscan -H 158.160.181.102 >> ~/.ssh/known_hosts
    - yarn

  cache:
    paths:
      - .yarn-cache
    key: ${CI_COMMIT_REF_SLUG}

build-all:
  stage: build
  script:
    - echo "üèó –ó–∞–ø—É—Å–∫–∞–µ–º yarn build:all"
    - yarn build:ui
    - yarn build:api
    - yarn install
    - yarn  build:web
    - echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤"
    - ls -la apps/web/.next || echo "‚ùå .next –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - ls -la packages/ui-kit/dist || echo "‚ùå dist ui-kit –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - ls -la packages/api/dist || echo "‚ùå dist api –Ω–µ –Ω–∞–π–¥–µ–Ω"
  artifacts:
    paths:
      - apps/web/.next
      - apps/web/public
      - apps/web/package.json
      - packages/ui-kit/dist
      - packages/api/dist
    expire_in: 1h
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

deploy-stage:
  stage: deploy
  script:
    - echo "üöÄ –î–µ–ø–ª–æ–π frontend"
    - rsync -az --delete apps/web/.next/ orest@158.160.181.102:/var/www/canadian-lawn/web/.next/
    - rsync -az --delete apps/web/public/ orest@158.160.181.102:/var/www/canadian-lawn/web/public/
    - rsync -az apps/web/package.json orest@158.160.181.102:/var/www/canadian-lawn/web/
    - ssh orest@158.160.181.102 '
      cd /var/www/canadian-lawn/web &&
      yarn install --production &&
      pm2 restart canadian-web || pm2 start "yarn start" --name canadian-web
      '
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
