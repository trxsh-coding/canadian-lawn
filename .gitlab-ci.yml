build_web:
  stage: build
  image: node:22

  cache:
    key: yarn-cache
    paths:
      - .yarn/cache
      - .yarn/install-state.gz
      - .yarn/build-state.yml
      - node_modules/

  before_script:
    - corepack enable
    - yarn set version 4.9.2
    - yarn install --no-immutable
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web

  script:
    - echo "ðŸ”¨ Build UI Kit"
    - yarn build:ui || (echo "âŒ UI Kit build failed" && exit 1)
    - test -d packages/ui-kit/dist || (echo "âŒ dist/ui-kit Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" && exit 1)

    - echo "ðŸ”¨ Build API"
    - yarn build:api || (echo "âŒ API build failed" && exit 1)
    - test -d packages/api/dist || (echo "âŒ dist/api Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" && exit 1)

    - echo "ðŸ”¨ Build Web"
    - yarn build:web || (echo "âŒ Web build failed" && exit 1)
    - test -d apps/web/.next || (echo "âŒ .next Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" && exit 1)

    - echo "ðŸš€ Copy to mounted folder"
    - cp -r apps/web/.next /mnt/www/canadian-lawn-front/.next
    - cp -r apps/web/public /mnt/www/canadian-lawn-front/public
    - cp apps/web/package.json /mnt/www/canadian-lawn-front/
    - echo "$ENV_FILE" > /mnt/www/canadian-lawn-front/.env

    - echo "ðŸ“¦ Install and start"
    - cd /mnt/www/canadian-lawn-front && yarn install --production
    - pm2 restart canadian-web || pm2 start "yarn start" --name canadian-web

  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

  artifacts:
    when: always
    expire_in: 1h
    paths:
      - packages/ui-kit/dist
      - packages/api/dist
      - apps/web/.next
      - apps/web/public
      - apps/web/package.json
