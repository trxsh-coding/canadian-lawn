stages:
  - db_up
  - build_and_deploy_web
  - build_and_deploy_backend

variables:
  DEST_DIR: "/var/www/canadian-lawn"

# ==========================
# ⚡️ POSTGRES (docker compose up)
# ==========================
db_up:
  stage: db_up
  tags:
    - deploy
  script:
    - docker-compose up -d postgres
  when: on_success
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

# ==========================
# ⚡️ WEB
# ==========================
build_and_deploy_web:
  stage: build_and_deploy_web
  tags:
    - deploy
  rules:
    - changes:
        - "apps/web/**/*"
        - "packages/ui-kit/**/*"
        - "packages/api/**/*"
  script:
    # 1️⃣ Копируем весь репозиторий
    - rsync -a . $DEST_DIR/
    - cd $DEST_DIR

    # 2️⃣ Установка зависимостей для Web
    - corepack enable
    - yarn set version 4.9.2
    - yarn install --no-immutable

    # 3️⃣ Сборка Web (через workspaces для ui-kit, api, web)
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web
    - yarn build:ui
    - yarn build:api
    - yarn build:web

    # 4️⃣ .env для Web
    - echo "$ENV_WEB" > $DEST_DIR/apps/web/.env

    # 5️⃣ Перезапускаем PM2 для Web
    - pm2 reload canadian-web || pm2 start "yarn workspace @canadian-lawn/web run start:prod" --name canadian-web

# ==========================
# ⚡️ BACKEND
# ==========================
build_and_deploy_backend:
  stage: build_and_deploy_backend
  tags:
    - deploy
  needs:
    - db_up
  rules:
    - changes:
        - "apps/backend/**/*"
  script:
    # 1️⃣ Копируем весь репозиторий
    - rsync -a . $DEST_DIR/
    - cd $DEST_DIR

    # 2️⃣ Установка зависимостей для Backend
    - corepack enable
    - yarn set version 4.9.2
    - yarn install --no-immutable
    - yarn workspaces focus @canadian-lawn/backend

    # 3️⃣ Сборка Backend
    - yarn build:backend

    # 4️⃣ .env для Backend
    - echo "$STRAPI_ENV_FILE" > $DEST_DIR/apps/backend/.env

    # 5️⃣ Установка production-зависимостей для Backend
    - yarn workspaces focus @canadian-lawn/backend --production

    # 6️⃣ Перезапускаем PM2 для Backend
    - pm2 reload canadian-api || pm2 start "yarn workspace @canadian-lawn/backend run start:prod" --name canadian-api
