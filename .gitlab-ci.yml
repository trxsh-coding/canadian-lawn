default:
  before_script:
    - sudo mkdir -p /var/www/canadian-lawn
    - sudo chown $USER:$USER /var/www/canadian-lawn

stages:
  - db_up
  - build_and_deploy_web
  - build_and_deploy_backend

variables:
  DEST_DIR: "/var/www/canadian-lawn"

# ==========================
# ⚡️ POSTGRES (docker compose up)
# ==========================
db_up:
  stage: db_up
  tags:
    - deploy
  script:
    - if docker ps --filter "label=com.docker.compose.service=postgres" --format '{{.Names}}' | grep -q .; then
      echo "Postgres already running.";
      else
      echo "Starting Postgres...";
      docker compose up -d postgres;
      fi
  when: on_success

# ==========================
# ⚡️ WEB
# ==========================
build_and_deploy_web:
  stage: build_and_deploy_web
  tags:
    - deploy
  rules:
    - changes:
        - "apps/web/**/*"
        - "packages/ui-kit/**/*"
        - "packages/api/**/*"
        - "gitlab-ci.yml"
  script:
    # 1️⃣ Синхронизируем репозиторий
    - rsync -a --delete . $DEST_DIR/

    # 2️⃣ Ставим только то, что нужно для WEB
    - cd $DEST_DIR
    - corepack enable
    - yarn set version 4.9.2
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web
    - yarn install --no-immutable

    # 3️⃣ Сборка WEB
    - yarn build:ui
    - yarn build:api
    - yarn build:web

    # 4️⃣ .env для WEB
    - echo "$ENV_WEB" > $DEST_DIR/apps/web/.env

    # 5️⃣ Перезапускаем PM2 для WEB
    - pm2 delete canadian-web || true
    - pm2 start $DEST_DIR/ecosystem.config.cjs
    - pm2 save

# ==========================
# ⚡️ BACKEND
# ==========================
build_and_deploy_backend:
  stage: build_and_deploy_backend
  tags:
    - deploy
  needs:
    - job: db_up
      optional: true
  rules:
    - changes:
        - "apps/backend/**/*"
        - "gitlab-ci.yml"
  script:
    # 1️⃣ Синхронизируем репозиторий
    - rsync -a --delete . $DEST_DIR/

    # 2️⃣ Ставим только то, что нужно для BACKEND
    - cd $DEST_DIR
    - corepack enable
    - yarn set version 4.9.2
    - yarn workspaces focus @canadian-lawn/backend
    - yarn install --no-immutable

    # 3️⃣ Сборка BACKEND
    - yarn build:backend

    # 4️⃣ .env для BACKEND
    - echo "$STRAPI_ENV_FILE" > $DEST_DIR/apps/backend/.env

    # 5️⃣ Ставим production-зависимости для BACKEND
    - yarn workspaces focus @canadian-lawn/backend --production
  after_script:
    - pm2 delete canadian-api || true
    - pm2 start $DEST_DIR/ecosystem.config.cjs
    - pm2 save
