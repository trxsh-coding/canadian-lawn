stages:
  - build_and_deploy

build_and_deploy:
  stage: build_and_deploy
  tags:
    - deploy
  script:
    # 1️⃣ Установка зависимостей в КОРНЕ
    - corepack enable
    - yarn set version 4.9.2
    - yarn install --no-immutable
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web

    # 2️⃣ Сборка
    - yarn build:ui
    - yarn build:api
    - yarn build:web
    - rm -rf apps/web/.next/cache

    # 3️⃣ Копируем ТОЛЬКО то, что нужно для standalone
    - DEST_DIR=/var/www/canadian-lawn
    - mkdir -p $DEST_DIR
    - rsync -a apps/web/.next/standalone/ $DEST_DIR/
    - rsync -a apps/web/.next/static $DEST_DIR/.next/static/
    - rsync -a apps/web/public $DEST_DIR/
    - echo "$ENV_FILE" > $DEST_DIR/.env

    # 4️⃣ Перезапускаем PM2
    - pm2 reload canadian-web || pm2 start "node server.js" --name canadian-web
