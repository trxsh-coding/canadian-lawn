stages:
  - db_up
  - build_and_deploy_web
  - build_and_deploy_backend

variables:
  DEST_DIR: "/var/www/canadian-lawn"

# ==========================
# ⚡️ POSTGRES (docker compose up)
# ==========================
db_up:
  stage: db_up
  tags:
    - deploy
  script:
    - docker compose up -d postgres
  when: on_success
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

# ==========================
# ⚡️ WEB
# ==========================
build_and_deploy_web:
  stage: build_and_deploy_web
  tags:
    - deploy
  rules:
    - changes:
        - "apps/web/**/*"
        - "packages/ui-kit/**/*"
        - "packages/api/**/*"
  script:
    # 1️⃣ Копируем весь репозиторий
    - rsync -a . $DEST_DIR/
    - cd $DEST_DIR

    # 2️⃣ Ставим только то, что нужно для WEB
    - corepack enable
    - yarn set version 4.9.2
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web
    - yarn install --no-immutable

    # 3️⃣ Сборка WEB
    - yarn build:ui
    - yarn build:api
    - yarn build:web

    # 4️⃣ .env для WEB
    - echo "$ENV_WEB" > $DEST_DIR/apps/web/.env

    # 5️⃣ Перезапускаем PM2 для WEB
    - pm2 reload canadian-web || pm2 start "yarn serve:web" --name canadian-web

# ==========================
# ⚡️ BACKEND
# ==========================
build_and_deploy_backend:
  stage: build_and_deploy_backend
  tags:
    - deploy
  needs:
    - job: db_up
      optional: true
  rules:
    - changes:
        - "apps/backend/**/*"
  script:
    # 1️⃣ Копируем весь репозиторий
    - rsync -a . $DEST_DIR/
    - cd $DEST_DIR

    # 2️⃣ Ставим только то, что нужно для BACKEND
    - corepack enable
    - yarn set version 4.9.2
    - yarn workspaces focus @canadian-lawn/backend
    - yarn install --no-immutable

    # 3️⃣ Сборка BACKEND
    - yarn build:backend

    # 4️⃣ .env для BACKEND
    - echo "$STRAPI_ENV_FILE" > $DEST_DIR/apps/backend/.env

    # 5️⃣ Ставим production-зависимости для BACKEND
    - yarn workspaces focus @canadian-lawn/backend --production

    # 6️⃣ Перезапускаем PM2 для BACKEND
    - pm2 reload canadian-api || pm2 start "yarn serve:backend" --name canadian-api
