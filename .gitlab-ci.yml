build_web:
  stage: build
  image: node:22

  cache:
    key: yarn-cache
    paths:
      - .yarn/cache
      - .yarn/install-state.gz
      - .yarn/build-state.yml
      - node_modules/

  before_script:
    - corepack enable
    - yarn set version 4.9.2
    - yarn install --no-immutable
    - yarn workspaces focus @canadian-lawn/ui-kit @canadian-lawn/api @canadian-lawn/web

  script:
    - echo "🔨 Build UI Kit"
    - yarn build:ui || (echo "❌ UI Kit build failed" && exit 1)
    - test -d packages/ui-kit/dist || (echo "❌ dist/ui-kit не найден" && exit 1)

    - echo "🔨 Build API"
    - yarn build:api || (echo "❌ API build failed" && exit 1)
    - test -d packages/api/dist || (echo "❌ dist/api не найден" && exit 1)

    - echo "🔨 Build Web"
    - yarn build:web || (echo "❌ Web build failed" && exit 1)
    - test -d apps/web/.next || (echo "❌ .next не найден" && exit 1)

    - echo "🚀 Copy to mounted folder"
    - cp -r apps/web/.next /mnt/www/canadian-lawn-front/.next
    - cp -r apps/web/public /mnt/www/canadian-lawn-front/public
    - cp apps/web/package.json /mnt/www/canadian-lawn-front/
    - echo "$ENV_FILE" > /mnt/www/canadian-lawn-front/.env

    - echo "📦 Install and start"
    - cd /mnt/www/canadian-lawn-front && yarn install --production
    - pm2 restart canadian-web || pm2 start "yarn start" --name canadian-web

  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

  artifacts:
    when: always
    expire_in: 1h
    paths:
      - packages/ui-kit/dist
      - packages/api/dist
      - apps/web/.next
      - apps/web/public
      - apps/web/package.json
